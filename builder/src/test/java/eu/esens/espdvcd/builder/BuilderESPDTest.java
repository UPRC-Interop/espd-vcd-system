package eu.esens.espdvcd.builder;

import eu.esens.espdvcd.builder.exception.BuilderException;
import eu.esens.espdvcd.model.ESPDRequest;
import eu.esens.espdvcd.model.ESPDResponse;

import java.io.InputStream;

import eu.esens.espdvcd.retriever.criteria.CriteriaExtractor;
import eu.esens.espdvcd.retriever.criteria.ECertisCriteriaExtractor;
import eu.esens.espdvcd.retriever.exception.RetrieverException;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Ignore;
import org.junit.Test;

public class BuilderESPDTest {
    
    InputStream isReq;
    InputStream isRes;
    
    public BuilderESPDTest() {
    }
    
    @Before
    public void setUp() {
        isReq = BuilderESPDTest.class.getResourceAsStream("/espd-request.xml");
        Assert.assertNotNull(isReq);
        
        isRes = BuilderESPDTest.class.getResourceAsStream("/espd-response.xml");
        Assert.assertNotNull(isRes);
    }

    @Ignore
    @Test
    public void createESPDRequestFromFile() throws Exception {
 
        // Here we load an ESPD Request generated by the EU Service
        ESPDRequest espd = BuilderFactory.V1.getModelBuilder().importFrom(isReq).createRegulatedESPDRequest();
        Assert.assertNotNull(espd);

        // We create an XML from our simple model 
        String XML = new XMLDocumentBuilderV1(espd).getAsString();
        Assert.assertNotNull(XML);
    //    System.out.println(XML);
    }

    @Ignore    
    @Test
    public void createESPDResponseFromFile() throws Exception {
        
      
        // Here we load an ESPD Request generated by the EU Service
        ESPDResponse espd = BuilderFactory.V1.getModelBuilder().importFrom(isRes).createRegulatedESPDResponse();
        Assert.assertNotNull(espd);

        // We create an XML from our simple model 
        String XML = new XMLDocumentBuilderV1(espd).getAsString();
        Assert.assertNotNull(XML);
//        System.out.println(XML);
    }
    
    @Ignore    
    @Test
    public void createESPDResponseFromESPDRequestFile() throws Exception {
        // Here we load an ESPD Request generated by the EU Service
        ESPDResponse espd = BuilderFactory.V1.getModelBuilder().importFrom(isReq).createRegulatedESPDResponse();
        Assert.assertNotNull(espd);

        // We create an XML from our simple model 
        String XML = new XMLDocumentBuilderV1(espd).getAsString();
        Assert.assertNotNull(XML);
//        System.out.println(XML);
    }
    
    @Ignore
    @Test
    public void deselectExclusionCriterion() throws Exception {

        // Here we load an ESPD Request generated by the EU Service
      
        ESPDRequest originalEspd = BuilderFactory.V1.getModelBuilder().importFrom(isReq).createRegulatedESPDRequest();
        Assert.assertNotNull(originalEspd);

        // Deselect the first exclusion criterion
        originalEspd.getExclusionCriteriaList().get(0).setSelected(false);
        
        Assert.assertEquals(62,originalEspd.getFullCriterionList().size());

        // Count the number of selected exclusion criteria and the total number of exclusion criteria in the original espd request
        int originalEspdExclusionCriteriaCount = originalEspd.getExclusionCriteriaList().size();
        long originalCriteriaSelectedCount = originalEspd.getFullCriterionList().stream()
                .filter(c -> c.isSelected())
                .count();
        
        long originalCriteriaNotSelectedCount = originalEspd.getFullCriterionList().stream()
                .filter(c -> !c.isSelected())
                .count();
        
        Assert.assertEquals(62, originalCriteriaNotSelectedCount + originalCriteriaSelectedCount);
        Assert.assertEquals(1, originalCriteriaNotSelectedCount);
        Assert.assertEquals(61, originalCriteriaSelectedCount);
       
        // Export the ESPD Request to Xml string
        
        ESPDRequest importedEspd;
            importedEspd = BuilderFactory.V1.getModelBuilder()
                    .importFrom(new XMLDocumentBuilderV1(originalEspd).getAsInputStream())
                    .addDefaultESPDCriteriaList()
                    .createRegulatedESPDRequest();
        
            Assert.assertNotNull(importedEspd);

        // Count the number of selected exclusion criteria and the total number of exclusion criteria in the imported espd request
        long importedEspdExclusionCriteriaCount = importedEspd.getExclusionCriteriaList().size();
        long importedEspdExclusionCriteriaSelectedCount = importedEspd
                .getExclusionCriteriaList()
                .stream()
                .filter(c -> c.isSelected())
                .count();

        // Compare the number of selected exclusion criteria in espd and importedEspd
        Assert.assertEquals(originalEspdExclusionCriteriaCount, importedEspdExclusionCriteriaCount);
        Assert.assertNotEquals(originalCriteriaSelectedCount, importedEspdExclusionCriteriaSelectedCount);
    }

    @Test
    public void createSimpleESPDRequestAndApplyEcertisData() throws BuilderException, RetrieverException {

        CriteriaExtractor extractor = new ECertisCriteriaExtractor();
        ESPDRequest req = BuilderFactory.getModelBuilder().createESPDRequest();
        req.setCriterionList(extractor.getFullList());
        System.out.println(BuilderFactory.getDocumentBuilderFor(req).theXML);
    }

    @Test
    public void createRegulatedESPDRequestV2() throws BuilderException, RetrieverException {

        CriteriaExtractor extractor = new ECertisCriteriaExtractor();
        ESPDRequest req = BuilderFactory.V2.getModelBuilder().createRegulatedESPDRequest();
        req.setCriterionList(extractor.getFullList());
        System.out.println(BuilderFactory.V2.getDocumentBuilderFor(req).theXML);
    }

}
